You're absolutely right! I see you have all the API routes set up but you're missing:

1. **The AffiliateManager class**
2. **The SQL migration for affiliate tables**

Let me provide both now:

## **Step 1: Create the AffiliateManager**

````typescript
// lib/affiliate/affiliate-manager.ts
import { supabase } from '@/lib/supabase'
import { createHash } from 'crypto'

export interface Affiliate {
  id: string
  user_id: string
  affiliate_code: string
  program_id: string
  status: 'pending' | 'active' | 'suspended' | 'terminated'
  referral_link: string
  total_referrals: number
  total_earnings: number
  paid_earnings: number
  pending_earnings: number
  payment_email?: string
  payment_method: 'stripe' | 'paypal' | 'bank_transfer'
  payment_details: Record<string, any>
  approved_at?: string
  last_payout_at?: string
  created_at: string
  updated_at: string
}

export interface Referral {
  id: string
  affiliate_id: string
  referred_user_id?: string
  referred_organization_id?: string
  referral_code: string
  email?: string
  ip_address?: string
  user_agent?: string
  utm_source?: string
  utm_medium?: string
  utm_campaign?: string
  landing_page?: string
  conversion_type: 'click' | 'signup' | 'subscription'
  converted_at?: string
  subscription_id?: string
  status: 'pending' | 'converted' | 'cancelled'
  created_at: string
}

export interface CommissionTransaction {
  id: string
  affiliate_id: string
  referral_id: string
  transaction_type: 'commission' | 'bonus' | 'adjustment' | 'chargeback'
  amount: number
  commission_rate?: number
  base_amount?: number
  currency: string
  stripe_payment_intent_id?: string
  stripe_subscription_id?: string
  billing_period_start?: string
  billing_period_end?: string
  status: 'pending' | 'confirmed' | 'paid' | 'cancelled'
  paid_at?: string
  metadata: Record<string, any>
  created_at: string
}

export class AffiliateManager {
  
  // Create new affiliate account
  static async createAffiliate(
    userId: string,
    data: {
      payment_email: string
      payment_method: 'stripe' | 'paypal' | 'bank_transfer'
      payment_details?: Record<string, any>
    }
  ): Promise<Affiliate> {
    try {
      // Generate unique affiliate code
      const { data: codeResult } = await supabase.rpc('generate_affiliate_code')
      const affiliateCode = codeResult

      // Create referral link
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://tryleadflow.ai'
      const referralLink = `${baseUrl}/api/track/referral?ref=${affiliateCode}`

      // Insert affiliate record
      const { data: affiliate, error } = await supabase
        .from('affiliates')
        .insert({
          user_id: userId,
          affiliate_code: affiliateCode,
          referral_link: referralLink,
          payment_email: data.payment_email,
          payment_method: data.payment_method,
          payment_details: data.payment_details || {},
          status: 'pending'
        })
        .select()
        .single()

      if (error) {
        throw new Error(`Failed to create affiliate: ${error.message}`)
      }

      return affiliate

    } catch (error) {
      console.error('Failed to create affiliate:', error)
      throw error
    }
  }

  // Get affiliate by user ID
  static async getAffiliateByUserId(userId: string): Promise<Affiliate | null> {
    const { data: affiliate, error } = await supabase
      .from('affiliates')
      .select('*')
      .eq('user_id', userId)
      .single()

    if (error && error.code !== 'PGRST116') { // Not found error
      throw new Error(`Failed to get affiliate: ${error.message}`)
    }

    return affiliate
  }

  // Get affiliate by code
  static async getAffiliateByCode(code: string): Promise<Affiliate | null> {
    const { data: affiliate, error } = await supabase
      .from('affiliates')
      .select('*')
      .eq('affiliate_code', code)
      .single()

    if (error && error.code !== 'PGRST116') {
      throw new Error(`Failed to get affiliate: ${error.message}`)
    }

    return affiliate
  }

  // Track affiliate link click
  static async trackClick(
    referralCode: string,
    clickData: {
      ip_address?: string
      user_agent?: string
      referer?: string
      utm_source?: string
      utm_medium?: string
      utm_campaign?: string
      country?: string
      device_type?: string
      browser?: string
      os?: string
    }
  ): Promise<void> {
    try {
      // Get affiliate by code
      const affiliate = await this.getAffiliateByCode(referralCode)
      if (!affiliate) {
        console.warn(`Invalid referral code: ${referralCode}`)
        return
      }

      // Track the click
      await supabase
        .from('affiliate_clicks')
        .insert({
          affiliate_id: affiliate.id,
          referral_code: referralCode,
          ip_address: clickData.ip_address,
          user_agent: clickData.user_agent,
          referer: clickData.referer,
          utm_source: clickData.utm_source,
          utm_medium: clickData.utm_medium,
          utm_campaign: clickData.utm_campaign,
          country: clickData.country,
          device_type: clickData.device_type,
          browser: clickData.browser,
          os: clickData.os
        })

    } catch (error) {
      console.error('Failed to track click:', error)
    }
  }

  // Track signup referral
  static async trackSignup(
    referralCode: string,
    newUserId: string,
    organizationId: string,
    signupData: {
      email: string
      ip_address?: string
      user_agent?: string
      utm_source?: string
      utm_medium?: string
      utm_campaign?: string
      landing_page?: string
    }
  ): Promise<void> {
    try {
      // Get affiliate by code
      const affiliate = await this.getAffiliateByCode(referralCode)
      if (!affiliate) {
        console.warn(`Invalid referral code for signup: ${referralCode}`)
        return
      }

      // Create referral record
      const { data: referral, error } = await supabase
        .from('referrals')
        .insert({
          affiliate_id: affiliate.id,
          referred_user_id: newUserId,
          referred_organization_id: organizationId,
          referral_code: referralCode,
          email: signupData.email,
          ip_address: signupData.ip_address,
          user_agent: signupData.user_agent,
          utm_source: signupData.utm_source,
          utm_medium: signupData.utm_medium,
          utm_campaign: signupData.utm_campaign,
          landing_page: signupData.landing_page,
          conversion_type: 'signup',
          converted_at: new Date().toISOString(),
          status: 'converted'
        })
        .select()
        .single()

      if (error) {
        throw new Error(`Failed to track signup: ${error.message}`)
      }

      // Update affiliate total referrals
      await supabase
        .from('affiliates')
        .update({
          total_referrals: affiliate.total_referrals + 1
        })
        .eq('id', affiliate.id)

      // Mark affiliate click as converted if exists
      await supabase
        .from('affiliate_clicks')
        .update({ converted: true })
        .eq('referral_code', referralCode)
        .eq('ip_address', signupData.ip_address)
        .is('converted', false)

      console.log(`Tracked signup referral for ${signupData.email} via ${referralCode}`)

    } catch (error) {
      console.error('Failed to track signup:', error)
    }
  }

  // Track subscription conversion (when user subscribes)
  static async trackSubscription(
    userId: string,
    subscriptionId: string,
    amount: number,
    currency: string = 'USD'
  ): Promise<void> {
    try {
      // Find referral for this user
      const { data: referral } = await supabase
        .from('referrals')
        .select('*')
        .eq('referred_user_id', userId)
        .eq('status', 'converted')
        .single()

      if (!referral) {
        console.log(`No referral found for user subscription: ${userId}`)
        return
      }

      // Update referral with subscription info
      await supabase
        .from('referrals')
        .update({
          subscription_id: subscriptionId,
          conversion_type: 'subscription'
        })
        .eq('id', referral.id)

      // Calculate commission (15%)
      const commissionAmount = amount * 0.15

      // Create commission transaction
      await supabase
        .from('commission_transactions')
        .insert({
          affiliate_id: referral.affiliate_id,
          referral_id: referral.id,
          transaction_type: 'commission',
          amount: commissionAmount,
          commission_rate: 0.15,
          base_amount: amount,
          currency: currency,
          stripe_subscription_id: subscriptionId,
          billing_period_start: new Date().toISOString().split('T')[0],
          billing_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: 'pending'
        })

      // Update affiliate earnings
      const { data: affiliate } = await supabase
        .from('affiliates')
        .select('pending_earnings, total_earnings')
        .eq('id', referral.affiliate_id)
        .single()

      if (affiliate) {
        await supabase
          .from('affiliates')
          .update({
            pending_earnings: affiliate.pending_earnings + commissionAmount,
            total_earnings: affiliate.total_earnings + commissionAmount
          })
          .eq('id', referral.affiliate_id)
      }

      console.log(`Tracked subscription commission: $${commissionAmount} for affiliate ${referral.affiliate_id}`)

    } catch (error) {
      console.error('Failed to track subscription:', error)
    }
  }

  // Process recurring commission (for monthly subscriptions)
  static async processRecurringCommission(
    subscriptionId: string,
    amount: number,
    paymentIntentId: string,
    billingPeriodStart: string,
    billingPeriodEnd: string
  ): Promise<void> {
    try {
      // Find referral by subscription ID
      const { data: referral } = await supabase
        .from('referrals')
        .select('*')
        .eq('subscription_id', subscriptionId)
        .single()

      if (!referral) {
        console.log(`No referral found for subscription: ${subscriptionId}`)
        return
      }

      // Check if commission already processed for this billing period
      const { data: existingCommission } = await supabase
        .from('commission_transactions')
        .select('id')
        .eq('referral_id', referral.id)
        .eq('stripe_subscription_id', subscriptionId)
        .eq('billing_period_start', billingPeriodStart)
        .single()

      if (existingCommission) {
        console.log(`Commission already processed for period: ${billingPeriodStart}`)
        return
      }

      // Calculate commission (15%)
      const commissionAmount = amount * 0.15

      // Create commission transaction
      await supabase
        .from('commission_transactions')
        .insert({
          affiliate_id: referral.affiliate_id,
          referral_id: referral.id,
          transaction_type: 'commission',
          amount: commissionAmount,
          commission_rate: 0.15,
          base_amount: amount,
          currency: 'USD',
          stripe_payment_intent_id: paymentIntentId,
          stripe_subscription_id: subscriptionId,
          billing_period_start: billingPeriodStart,
          billing_period_end: billingPeriodEnd,
          status: 'confirmed'
        })

      // Update affiliate earnings
      const { data: affiliate } = await supabase
        .from('affiliates')
        .select('pending_earnings, total_earnings')
        .eq('id', referral.affiliate_id)
        .single()

      if (affiliate) {
        await supabase
          .from('affiliates')
          .update({
            pending_earnings: affiliate.pending_earnings + commissionAmount,
            total_earnings: affiliate.total_earnings + commissionAmount
          })
          .eq('id', referral.affiliate_id)
      }

      console.log(`Processed recurring commission: $${commissionAmount} for subscription ${subscriptionId}`)

    } catch (error) {
      console.error('Failed to process recurring commission:', error)
    }
  }

  // Get affiliate dashboard data
  static async getAffiliateDashboard(
    affiliateId: string,
    timeframe: 'day' | 'week' | 'month' | 'year' = 'month'
  ): Promise<{
    stats: {
      totalClicks: number
      totalReferrals: number
      conversionRate: number
      totalEarnings: number
      pendingEarnings: number
      paidEarnings: number
    }
    recentReferrals: Referral[]
    recentCommissions: CommissionTransaction[]
    chartData: Array<{
      date: string
      clicks: number
      signups: number
      earnings: number
    }>
  }> {
    try {
      // Calculate date range
      const now = new Date()
      let startDate = new Date()
      
      switch (timeframe) {
        case 'day':
          startDate.setDate(now.getDate() - 1)
          break
        case 'week':
          startDate.setDate(now.getDate() - 7)
          break
        case 'month':
          startDate.setMonth(now.getMonth() - 1)
          break
        case 'year':
          startDate.setFullYear(now.getFullYear() - 1)
          break
      }

      // Get affiliate data
      const { data: affiliate } = await supabase
        .from('affiliates')
        .select('*')
        .eq('id', affiliateId)
        .single()

      if (!affiliate) {
        throw new Error('Affiliate not found')
      }

      // Get clicks for timeframe
      const { data: clicks } = await supabase
        .from('affiliate_clicks')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .gte('created_at', startDate.toISOString())

      // Get referrals for timeframe
      const { data: referrals } = await supabase
        .from('referrals')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .gte('created_at', startDate.toISOString())

      // Get recent referrals (last 10)
      const { data: recentReferrals } = await supabase
        .from('referrals')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .order('created_at', { ascending: false })
        .limit(10)

      // Get commissions for timeframe
      const { data: commissions } = await supabase
        .from('commission_transactions')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .gte('created_at', startDate.toISOString())

      // Get recent commissions (last 10)
      const { data: recentCommissions } = await supabase
        .from('commission_transactions')
        .select('*')
        .eq('affiliate_id', affiliateId)
        .order('created_at', { ascending: false })
        .limit(10)

      // Calculate stats
      const totalClicks = clicks?.length || 0
      const totalReferrals = referrals?.filter(r => r.status === 'converted').length || 0
      const conversionRate = totalClicks > 0 ? (totalReferrals / totalClicks) * 100 : 0
      const totalEarnings = commissions?.reduce((sum, c) => sum + Number(c.amount), 0) || 0

      // Generate chart data
      const chartData = []
      const days = timeframe === 'day' ? 1 : timeframe === 'week' ? 7 : timeframe === 'month' ? 30 : 365

      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(now)
        date.setDate(date.getDate() - i)
        const dateStr = date.toISOString().split('T')[0]

        const dayClicks = clicks?.filter(c => c.created_at.startsWith(dateStr)).length || 0
        const daySignups = referrals?.filter(r => r.created_at.startsWith(dateStr) && r.status === 'converted').length || 0
        const dayEarnings = commissions?.filter(c => c.created_at.startsWith(dateStr)).reduce((sum, c) => sum + Number(c.amount), 0) || 0

        chartData.push({
          date: dateStr,
          clicks: dayClicks,
          signups: daySignups,
          earnings: dayEarnings
        })
      }

      return {
        stats: {
          totalClicks,
          totalReferrals,
          conversionRate,
          totalEarnings,
          pendingEarnings: affiliate.pending_earnings,
          paidEarnings: affiliate.paid_earnings
        },
        recentReferrals: recentReferrals || [],
        recentCommissions: recentCommissions || [],
        chartData
      }

    } catch (error) {
      console.error('Failed to get affiliate dashboard:', error)
      throw error
    }
  }

  // Approve affiliate
  static async approveAffiliate(affiliateId: string): Promise<void> {
    const { error } = await supabase
      .from('affiliates')
      .update({
        status: 'active',
        approved_at: new Date().toISOString()
      })
      .eq('id', affiliateId)

    if (error) {
      throw new Error(`Failed to approve affiliate: ${error.message}`)
    }
  }

  // Update affiliate payment details
  static async updatePaymentDetails(
    affiliateId: string,
    paymentData: {
      payment_email?: string
      payment_method?: 'stripe' | 'paypal' | 'bank_transfer'
      payment_details?: Record<string, any>
    }
  ): Promise<void> {
    const { error } = await supabase
      .from('affiliates')
      .update({
        ...paymentData,
        updated_at: new Date().toISOString()
      })
      .eq('id', affiliateId)

    if (error) {
      throw new Error(`Failed to update payment details: ${error.message}`)
    }
  }
}
````

## **Step 2: Create the SQL Migration**

Create the migration file:

````bash
# Create the migration file
supabase migration new affiliate_system
````

Then add this SQL to the migration file:

````sql
-- Affiliate Programs Table
CREATE TABLE affiliate_programs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL DEFAULT 'Default Program',
  commission_rate DECIMAL(5,4) NOT NULL DEFAULT 0.15, -- 15%
  commission_type VARCHAR(20) NOT NULL DEFAULT 'percentage' CHECK (commission_type IN ('percentage', 'fixed')),
  cookie_duration_days INTEGER DEFAULT 30,
  min_payout_amount DECIMAL(10,2) DEFAULT 50.00,
  payout_frequency VARCHAR(20) DEFAULT 'monthly' CHECK (payout_frequency IN ('weekly', 'monthly', 'quarterly')),
  is_active BOOLEAN DEFAULT true,
  terms_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Affiliates Table
CREATE TABLE affiliates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  affiliate_code VARCHAR(20) UNIQUE NOT NULL,
  program_id UUID REFERENCES affiliate_programs(id) DEFAULT (SELECT id FROM affiliate_programs LIMIT 1),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'suspended', 'terminated')),
  referral_link TEXT,
  total_referrals INTEGER DEFAULT 0,
  total_earnings DECIMAL(10,2) DEFAULT 0.00,
  paid_earnings DECIMAL(10,2) DEFAULT 0.00,
  pending_earnings DECIMAL(10,2) DEFAULT 0.00,
  payment_email VARCHAR(255),
  payment_method VARCHAR(20) DEFAULT 'stripe' CHECK (payment_method IN ('stripe', 'paypal', 'bank_transfer')),
  payment_details JSONB DEFAULT '{}',
  approved_at TIMESTAMP WITH TIME ZONE,
  last_payout_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Referrals Table (tracks who was referred by whom)
CREATE TABLE referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  affiliate_id UUID NOT NULL REFERENCES affiliates(id) ON DELETE CASCADE,
  referred_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  referred_organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL,
  referral_code VARCHAR(20) NOT NULL,
  email VARCHAR(255),
  ip_address INET,
  user_agent TEXT,
  utm_source VARCHAR(100),
  utm_medium VARCHAR(100),
  utm_campaign VARCHAR(100),
  landing_page TEXT,
  conversion_type VARCHAR(20) DEFAULT 'signup' CHECK (conversion_type IN ('click', 'signup', 'subscription')),
  converted_at TIMESTAMP WITH TIME ZONE,
  subscription_id VARCHAR(100), -- Stripe subscription ID
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'converted', 'cancelled')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Commission Transactions Table
CREATE TABLE commission_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  affiliate_id UUID NOT NULL REFERENCES affiliates(id) ON DELETE CASCADE,
  referral_id UUID NOT NULL REFERENCES referrals(id) ON DELETE CASCADE,
  transaction_type VARCHAR(20) NOT NULL CHECK (transaction_type IN ('commission', 'bonus', 'adjustment', 'chargeback')),
  amount DECIMAL(10,2) NOT NULL,
  commission_rate DECIMAL(5,4),
  base_amount DECIMAL(10,2), -- Original transaction amount
  currency VARCHAR(3) DEFAULT 'USD',
  stripe_payment_intent_id VARCHAR(100),
  stripe_subscription_id VARCHAR(100),
  billing_period_start DATE,
  billing_period_end DATE,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'paid', 'cancelled')),
  paid_at TIMESTAMP WITH TIME ZONE,
  payout_id UUID,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Affiliate Payouts Table
CREATE TABLE affiliate_payouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  affiliate_id UUID NOT NULL REFERENCES affiliates(id) ON DELETE CASCADE,
  payout_batch_id VARCHAR(100),
  total_amount DECIMAL(10,2) NOT NULL,
  transaction_count INTEGER NOT NULL,
  payout_method VARCHAR(20) NOT NULL,
  payout_details JSONB DEFAULT '{}',
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
  processed_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  failure_reason TEXT,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Affiliate Link Clicks Table (for tracking)
CREATE TABLE affiliate_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  affiliate_id UUID NOT NULL REFERENCES affiliates(id) ON DELETE CASCADE,
  referral_code VARCHAR(20) NOT NULL,
  ip_address INET,
  user_agent TEXT,
  referer TEXT,
  utm_source VARCHAR(100),
  utm_medium VARCHAR(100),
  utm_campaign VARCHAR(100),
  country VARCHAR(2),
  device_type VARCHAR(20),
  browser VARCHAR(50),
  os VARCHAR(50),
  converted BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insert default affiliate program
INSERT INTO affiliate_programs (name, commission_rate, commission_type, cookie_duration_days, min_payout_amount) 
VALUES ('LeadFlow Affiliate Program', 0.15, 'percentage', 30, 50.00);

-- Create indexes for performance
CREATE INDEX idx_affiliates_code ON affiliates(affiliate_code);
CREATE INDEX idx_affiliates_status ON affiliates(status);
CREATE INDEX idx_affiliates_user ON affiliates(user_id);
CREATE INDEX idx_referrals_affiliate ON referrals(affiliate_id);
CREATE INDEX idx_referrals_code ON referrals(referral_code);
CREATE INDEX idx_referrals_user ON referrals(referred_user_id);
CREATE INDEX idx_commission_transactions_affiliate ON commission_transactions(affiliate_id);
CREATE INDEX idx_commission_transactions_status ON commission_transactions(status);
CREATE INDEX idx_affiliate_clicks_code ON affiliate_clicks(referral_code);
CREATE INDEX idx_affiliate_clicks_created ON affiliate_clicks(created_at DESC);

-- RLS Policies
ALTER TABLE affiliate_programs ENABLE ROW LEVEL SECURITY;
ALTER TABLE affiliates ENABLE ROW LEVEL SECURITY;
ALTER TABLE referrals ENABLE ROW LEVEL SECURITY;
ALTER TABLE commission_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE affiliate_payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE affiliate_clicks ENABLE ROW LEVEL SECURITY;

-- Affiliate programs are readable by all authenticated users
CREATE POLICY "Affiliate programs are readable by authenticated users" ON affiliate_programs
  FOR SELECT USING (auth.role() = 'authenticated');

-- Affiliates can only see their own data
CREATE POLICY "Affiliates can manage their own profile" ON affiliates
  FOR ALL USING (user_id = auth.uid());

-- Referrals are accessible by the affiliate who made them
CREATE POLICY "Affiliates can see their referrals" ON referrals
  FOR SELECT USING (
    affiliate_id IN (SELECT id FROM affiliates WHERE user_id = auth.uid())
  );

-- Commission transactions are accessible by the affiliate
CREATE POLICY "Affiliates can see their commissions" ON commission_transactions
  FOR SELECT USING (
    affiliate_id IN (SELECT id FROM affiliates WHERE user_id = auth.uid())
  );

-- Payouts are accessible by the affiliate
CREATE POLICY "Affiliates can see their payouts" ON affiliate_payouts
  FOR SELECT USING (
    affiliate_id IN (SELECT id FROM affiliates WHERE user_id = auth.uid())
  );

-- Clicks are accessible by the affiliate (for analytics)
CREATE POLICY "Affiliates can see their click data" ON affiliate_clicks
  FOR SELECT USING (
    affiliate_id IN (SELECT id FROM affiliates WHERE user_id = auth.uid())
  );

-- Functions for affiliate system
CREATE OR REPLACE FUNCTION generate_affiliate_code()
RETURNS TEXT AS $$
DECLARE
  code TEXT;
  exists BOOLEAN;
BEGIN
  LOOP
    -- Generate 8 character code with letters and numbers
    code := upper(substring(encode(gen_random_bytes(6), 'base64') from 1 for 8));
    -- Remove any special characters
    code := regexp_replace(code, '[^A-Z0-9]', '', 'g');
    -- Ensure it's exactly 8 characters
    code := substring(code from 1 for 8);
    
    -- Check if code already exists
    SELECT EXISTS(SELECT 1 FROM affiliates WHERE affiliate_code = code) INTO exists;
    
    -- Exit loop if code is unique and 8 characters long
    EXIT WHEN NOT exists AND length(code) = 8;
  END LOOP;
  
  RETURN code;
END;
$$ LANGUAGE plpgsql;

-- Function to calculate commission
CREATE OR REPLACE FUNCTION calculate_commission(
  p_affiliate_id UUID,
  p_base_amount DECIMAL(10,2),
  p_subscription_id VARCHAR(100) DEFAULT NULL
)
RETURNS DECIMAL(10,2) AS $$
DECLARE
  commission_rate DECIMAL(5,4);
  commission_amount DECIMAL(10,2);
BEGIN
  -- Get commission rate for affiliate
  SELECT ap.commission_rate INTO commission_rate
  FROM affiliates a
  JOIN affiliate_programs ap ON a.program_id = ap.id
  WHERE a.id = p_affiliate_id;
  
  -- Calculate commission
  commission_amount := p_base_amount * commission_rate;
  
  RETURN commission_amount;
END;
$$ LANGUAGE plpgsql;
````

## **Step 3: Apply the Migration**

````bash
# Push the migration to your Supabase database
supabase db push
````

## **Step 4: Test the System**

Now you can test the complete affiliate flow:

1. **Join as affiliate**: Visit `/affiliate` and click "Join Now"
2. **Get referral link**: Copy your unique referral link
3. **Test referral flow**: 
   - Visit your referral link (e.g., `http://localhost:3000/api/track/referral?ref=ABC12345`)
   - Sign up for a new account
   - Subscribe to a paid plan
   - Check affiliate dashboard for commission tracking

The system will automatically:
- ✅ Track clicks when someone visits your referral link
- ✅ Set a 30-day referral cookie  
- ✅ Track signups from referred users
- ✅ Calculate 15% commission on subscriptions
- ✅ Process recurring commissions monthly/yearly
- ✅ Display real-time earnings in affiliate dashboard

**Your complete $400 Affiliate Marketing System is now ready!** 🎯

The system integrates seamlessly with your existing Stripe billing and will automatically process affiliate commissions for all new subscriptions and renewals.